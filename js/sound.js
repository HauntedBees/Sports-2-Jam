const captions = {
    "spk_logo": "da Sports 2. Become one with the game!",
    "spk_letsplay": "Zenn: Let's play some BaseSol!", 
    "spk_teamComments0_0": "Zenn: I had lunch with a centaur once. Great guy. He could really go to town on a plate full of hay.", 
    "spk_teamComments0_1": "Zenn: I'd say you should wear a jacket if you plan on visiting Greenland, but physically visiting places is very last-century! You don't need a jacket if you astrally project there! Ha ha!", 
    "spk_teamComments0_2": "Zenn: The Sisimiut Centaurs have won three championship games so far, which is pretty impressive considering they've only been in two! Parallel universes really mess with bookkeeping!", 
    "spk_teamComments1_0": "Zenn: I tell you, you haven't had Bujumburan coffee until you've had Bujumburan coffee!", 
    "spk_teamComments1_1": "Zenn: The stars say that if you're a Taurus, you should keep an eye on your pets this weekend! They might be more hectic than usual!", 
    "spk_teamComments1_2": "Zenn: Lake Tanganyika in Burundi became the deepest lake in the world after an asteroid crashed into it a few years back! Take that, Lake Baikal! Ha ha!", 
    "spk_teamComments2_0": "Zenn: Sydney was just a couple kilometers south of the Event that decimated a large part of eastern Australia. Talk about close calls!", 
    "spk_teamComments2_1": "Zenn: There's always fun in store when the Sydney Scales are playing! I wish the same was true about my bathroom scale! Ha ha!", 
    "spk_teamComments2_2": "Zenn: The Sydney Scales are on their way to the championships this year, as long as their coach doesn't fumble their strategy like they did in 2989!", 
    "spk_teamComments3_0": "Zenn: The players of the Makhachkala Rams always donate a portion of their winnings to the Russian Block Stacking Game You Know The One Foundation for the Sciences.", 
    "spk_teamComments3_1": "Zenn: Last week I was swimming deep in the Pacific and I came across a cow covered in plants. Oh, I'm sorry, I'm thinking of the wrong Moscow. Sorry, Russia!", 
    "spk_teamComments3_2": "Zenn: The clear skies in western Russia give the Rams a beautiful view of the stars to plan their plays with!", 
    "spk_teamComments4_0": "Zenn: Not much data about food from the old times has survived, but I thank the stars that the recipe for croissants wasn't lost!", 
    "spk_teamComments4_1": "Zenn: The Eiffel Tower 2 is always a sight to behold; the Seine Scorpions are lucky to live so close to it!", 
    "spk_teamComments4_2": "Zenn: With skills as good as theirs, you'd think the Seine Scorpions could predict the future! They probably can! Chakras are wild like that.", 
    "spk_teamComments5_0": "Zenn: I know I don't look the type, but I'm a big fan of Japanese classical music! That old standard Cruel Angel's Thesis never disappoints!", 
    "spk_teamComments5_1": "Zenn: For the first 30 years of Basesol, the Tokyo Twins got away with having 40 players on their team by saying they were twins! I can't believe they got away with that for so long!", 
    "spk_teamComments5_2": "Zenn: My first crush when I was much younger was from Tokyo. Unfortunately, universal translators were still a few years away from being perfected, so all I could say to them was \"Where's the bathroom?\"", 
    "spk_teamComments6_0": "Zenn: Here's my impression of a goat: baa! baaa! goaaat! Wait, it's sheep that go \"baa,\" isn't it?", 
    "spk_teamComments6_1": "Zenn: Peru is home to many famous historical landmarks like Machu Picchu, Qorikancha, and the Plaza Norte Shopping Center.", 
    "spk_teamComments6_2": "Zenn: Qusqu's flag is a rainbow of colors, and it reminds me of my favorite rainbow: the kind you can taste. Purchase Proprietary Fruit Chews today, kids!", 
    "spk_teamComments7_0": "Zenn: San Diego is a wonderful city to visit, as long as you don't fly in from the east. Flying over eastern North America is never a good idea.", 
    "spk_teamComments7_1": "Zenn: Believe it or not, California used to be part of the former United States before Mexico called dibs and reclaimed it during the U.S. Collapse.", 
    "spk_teamComments7_2": "Zenn: The waterbearer is an important role these days, and I would like to thank all of our waterbearers keeping the world wet and hydrated every day.", 
    "spk_teamComments8_0": "Zenn: Atlantis rose from the ocean only 200 years ago, and they've already produced one of the best teams in the league in such a short time! Truly amazing.", 
    "spk_teamComments8_1": "Zenn: I'm not much for seafood, but whenever I visit Atlantis for a game, I can't leave until I've stuffed myself on fried anchovies!", 
    "spk_teamComments8_2": "Zenn: The Atlanteans are proud of their star becomer, Regorty Grimentond, as chosen by their infallible clockwork supercomputer POSEIDON.", 
    "spk_teamComments9_0": "Zenn: The Snow Crab is named after snow, an ancient weather condition that was like acid rain, but nontoxic and apparently fun to play around in!", 
    "spk_teamComments9_1": "Zenn: I love my job, but if I ever had to change it up, I'd want to be a food critic in Korea! I could eat kimchi with every meal! Or just constantly, without ever stopping!", 
    "spk_teamComments9_2": "Zenn: The Seoul Snow Crabs have won more championships than any other team in the League, and they've got their pitcher Ingunna Assa to thank for a lot of those wins!", 
    "spk_teamComments10_0": "Zenn: Colombian hot chocolate is delicious, but if you have time to go out to a supernova, heating the chocolate to 11,000 degrees really brings out some extra rich flavors!", 
    "spk_teamComments10_1": "Zenn: Colombia obviously has an excellent Basesol team, but their Grundleshort team, the Santa Marta Quigglebops, are truly unparalleled!", 
    "spk_teamComments10_2": "Zenn: South America almost separated from North America a few years ago but Colombian geologist Unglurt Siquez secured the continents together with some electric tape.", 
    "spk_teamComments11_0": "Zenn: They say it's better to be a lion among sheep than a sheep among lions, but I'd rather be a human among humans! Ha ha! I haven't seen another human in person in weeks.", 
    "spk_teamComments11_1": "Zenn: Many members of the Lilongwe Lions are graduates from the University of Malawi. Walen Gubard graduated last year with a degree in Cryptozoology, which is sadly quite similar to regular Zoology these days!", 
    "spk_teamComments11_2": "Zenn: Malawi is one of only two landlocked countries in the International Association to Glue the Moon Back Together!",
    "spk_random0": "Zenn: This game is going to go down in history.",
    "spk_random1": "Zenn: I hope the viewers at home are enjoying this game as much as I am.",
    "spk_random2": "Zenn: Now this is what I call Sports. 2.",
    "spk_random3": "Zenn: I have not seen a match like this in years.",
    "spk_random4": "Zenn: Games like this remind me of why I took this job in the first place.",
    "spk_random5": "Zenn: I hope this game wraps up soon, I need to go home and watch Oprah 2.",
    "spk_random6": "Zenn: This game is proudly sponsored by d.a. sports 2. Buy their games!",
    "spk_random7": "Zenn: I meditated on this game for seven days and seven nights. It's going to be a good one, folks.",
    "spk_random8": "Zenn: Remember when the pickle went extinct?",
    "spk_random9": "Zenn: We would like to remind our extra-dimensional viewers that attempting to alter the outcome of the game is strictly forbidden under penalty of space law.",
    "spk_solHit0": "Zenn: Excellent form.",
    "spk_solHit1": "Zenn: A beautiful projection.",
    "spk_solHit2": "Zenn: And it's off!",
    "spk_solHit3": "Zenn: Here we go!"
};
const miscFillers = [
    // 0-9: commentary on constellation choice
    "Let's see how that plays out.",
    "A fan favorite.",
    "A wise choice.",
    "Not a bad move on their part.",
    "That's caused problems for them before.",
    "Excellent strategy as always.",
    "A safe bet in this round.",
    "You love to see it.",
    "Bold move.",
    "The suspense rises.",
    // 10-13: up to bat
    "{0} is up.",
    "{0}, ready to go.",
    "Here comes {0}.",
    "Get ready for {0}.",
    // 14-16: catching
    "The Sol has been caught.",
    "Excellent catch from {0}.",
    "{0} caught the Sol."
];

const SpeakHandler = {
    captionTimer: 0,
    Speakers: {
        "Zenn" : { variant: "f3", pitch: 5, speed: 170 },
        "Announcer": { variant: "m2", pitch: 50, speed: 110, wordgap: 1 }
    },
    SpeakRandomTeamComment(team1Idx, team2Idx) {
        const teamId = (Math.random() <= 0.5 ? team1Idx : team2Idx);
        SpeakHandler.SpeakFromKey(`spk_teamComments${teamId}_${RandRange(0, 3)}`);
    },
    SpeakMiscFiller(a, b, replacement) {
        const val = miscFillers[RandRange(a, b)];
        if(replacement === undefined) { return val; }
        SpeakHandler.Speak(val.replace("{0}", replacement));
    },
    counter: 0,
    Refresh(callback) {
        meSpeak.refresh();
        meSpeak.loadVoice("voices/en-us.json", callback);
    },
    Speak: function(text, person, noCaption) {
        SpeakHandler.Stop();
        person = person || "Zenn";
        if(noCaption !== true) { SpeakHandler.StartCaption(person, text); }
        if(!playerOptions["voice"].value) { return; }
        if(++this.counter > 70) {
            this.counter = 0;
            SpeakHandler.Refresh(function() { meSpeak.speak(text, SpeakHandler.Speakers[person]); });
            return;
        }
        meSpeak.speak(text, SpeakHandler.Speakers[person]);
    },
    SpeakFromKey: function(key) {
        SpeakHandler.Stop();
        if(captions[key] !== undefined) { // team names don't have captions
            SpeakHandler.StartCaption("", captions[key]);
        }
        if(!playerOptions["voice"].value) { return; }
        Sounds.PlaySound(key, false, true);
    },
    Stop: function() {
        SpeakHandler.EndCaption();
        Sounds.EndSpoken();
        meSpeak.stop();
    },
    StartCaption(person, text) {
        if(!playerOptions["captions"].value) { return; }
        if(person === "") {
            document.getElementById("captionsText").textContent = text;
        } else {
            document.getElementById("captionsText").textContent = person + ": " + text;
        }
        SpeakHandler.EndCaption();
        document.getElementById("captions").style["display"] = "block";
        this.captionTimer = setTimeout(SpeakHandler.EndCaption, 500 + text.length * 90);
    },
    EndCaption() {
        clearTimeout(this.captionTimer);
        this.captionTimer = 0;
        document.getElementById("captions").style["display"] = "none";
    }
};
const Sounds = {
    /** @type {{[key:string] : HTMLAudioElement }} */ SoundTable: {},
    /** @type {string[]} */ ActiveSoundEffects: [],
    /** @type {string} */ ActiveSong: "", 
    Init: function(innerSoundCallback, finalSoundCallback, innerMusicCallback, finalMusicCallback) {
        const sounds = ["confirm", "cancel", "playBall", "switch_01", "switch_02", "pot_01",
                        "plop_01", "plop_02", "spring_06", "metal_04", "metal_05", "explosion",
                        "glass_01", "glass_02", "glass_03", "glass_04", "glass_05", "gong_01",
                        // Boring Speakies
                        "spk_logo", "spk_letsplay",  
                        // Team Names
                        "spk_teamName0", "spk_teamName1", "spk_teamName2", "spk_teamName3", "spk_teamName4", "spk_teamName5",
                        "spk_teamName6","spk_teamName7", "spk_teamName8", "spk_teamName9", "spk_teamName10", "spk_teamName11", 
                        // Random Comments
                        "spk_random0", "spk_random1", "spk_random2", "spk_random3", "spk_random4",
                        "spk_random5", "spk_random6", "spk_random7", "spk_random8", "spk_random9",
                        // Team Comments
                        "spk_teamComments0_0", "spk_teamComments0_1", "spk_teamComments0_2",
                        "spk_teamComments1_0", "spk_teamComments1_1", "spk_teamComments1_2", 
                        "spk_teamComments2_0", "spk_teamComments2_1", "spk_teamComments2_2", 
                        "spk_teamComments3_0", "spk_teamComments3_1", "spk_teamComments3_2", 
                        "spk_teamComments4_0", "spk_teamComments4_1", "spk_teamComments4_2", 
                        "spk_teamComments5_0", "spk_teamComments5_1", "spk_teamComments5_2", 
                        "spk_teamComments6_0", "spk_teamComments6_1", "spk_teamComments6_2", 
                        "spk_teamComments7_0", "spk_teamComments7_1", "spk_teamComments7_2",
                        "spk_teamComments8_0", "spk_teamComments8_1", "spk_teamComments8_2", 
                        "spk_teamComments9_0", "spk_teamComments9_1", "spk_teamComments9_2", 
                        "spk_teamComments10_0", "spk_teamComments10_1", "spk_teamComments10_2",
                        "spk_teamComments11_0", "spk_teamComments11_1", "spk_teamComments11_2",
                        // Hit the Sol
                        "spk_solHit0", "spk_solHit1", "spk_solHit2", "spk_solHit3"
        ];
        let soundCount = 0, soundLen = sounds.length;
        sounds.forEach(s => {
            const sound = new Audio("sound/" + s + ".ogg");
            sound.onended = function() {
                let i = Sounds.ActiveSoundEffects.indexOf(s);
                if(i >= 0) { Sounds.ActiveSoundEffects.splice(i, 1); }
            };
            sound.addEventListener("canplay", function() {
                soundCount += 1;
                innerSoundCallback(soundCount / soundLen);
                if(soundCount === soundLen) { finalSoundCallback(); }
            });
            Sounds.SoundTable[s] = sound;
        });
        const music = ["song_awake", "song_neospringcore"];
        let musicCount = 0, musicLen = music.length;
        music.forEach(s => {
            const song = new Audio("sound/" + s + ".ogg");
            song.addEventListener("canplay", function() {
                musicCount += 1;
                innerMusicCallback(musicCount / musicLen);
                if(musicCount === musicLen) { finalMusicCallback(); }
            });
            song.loop = true;
            Sounds.SoundTable[s] = song;
        });
    },
    PlaySong: /** @param {string} name @param {number} [forcedVolume] */
    function(name, forcedVolume) {
        if(!playerOptions["music"].value) { return; }
        if(Sounds.ActiveSong === name) {
            Sounds.SoundTable[name].play();
            return;
        }
        Sounds.StopSong();
        //console.log(`Now Playing: ${name}`);
        Sounds.ActiveSong = name;
        Sounds.SoundTable[name].currentTime = 0;
        Sounds.SoundTable[name].volume = forcedVolume || 0.05;//(forcedVolume || player.options.sound) / 20;
        Sounds.SoundTable[name].play();
    },
    StopSong() {
        if(Sounds.ActiveSong === "") { return; }
        Sounds.SoundTable[Sounds.ActiveSong].pause();
    },
    ResumeSong() {
        if(Sounds.ActiveSong === "") { return; }
        Sounds.SoundTable[Sounds.ActiveSong].play();
    },
    PlaySound: /** @param {string} name @param {boolean} [persistTransition] @param {boolean} [isSpoken] @param {number} [forcedVolume] */
    function(name, persistTransition, isSpoken, forcedVolume) {
        if(!isSpoken && !playerOptions["sound"].value) { return; }
        //console.log(`Now Playing: ${name}`);
        if(!persistTransition) { Sounds.ActiveSoundEffects.push(name); }
        Sounds.SoundTable[name].currentTime = 0;
        Sounds.SoundTable[name].volume = forcedVolume || 0.1;//(forcedVolume || player.options.sound) / 20;
        Sounds.SoundTable[name].play();
    },
    EndSpecific: function(name) {
        Sounds.SoundTable[name].pause();
    },
    Pause: function() {
        Sounds.ActiveSoundEffects.forEach(s => Sounds.SoundTable[s].pause());
        Sounds.StopSong();
    },
    Unpause: function() {
        Sounds.ActiveSoundEffects.forEach(s => Sounds.SoundTable[s].play());
        Sounds.ResumeSong();
    },
    EndSpoken: function() {
        for(let i = Sounds.ActiveSoundEffects.length - 1; i >= 0; i--) {
            const s = Sounds.ActiveSoundEffects[i];
            if(s.indexOf("spk_") === 0) {
                Sounds.SoundTable[s].pause();
                Sounds.ActiveSoundEffects.splice(i, 1);
            }
        }
    },
    EndAll: function() {
        Sounds.ActiveSoundEffects.forEach(s => Sounds.SoundTable[s].pause());
        Sounds.ActiveSoundEffects = [];
    }
};